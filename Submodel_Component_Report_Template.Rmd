---
title: " `r paste(params$component_name)` Component of the `r paste(params$tab_name, 'Submodel Report')`"
date: "`r format(Sys.time(), '%B %d, %Y at %H:%M:%S')`"
output: 
  html_document:
    theme:
      version: 5
      brand: _brand.yml
    toc: true
    toc_float: true
    self_contained: true
params:
  map_configs: NULL
  combined_data: NULL
  combined_data_list: NULL    
  selected_methods: NULL    
  tab_name: NULL
  combined_map_title: "Combined Map"
  data_timestamps: NULL
  component_name: NULL
  aoi_data: NULL
---

```{css, include = FALSE}
<style>
body {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
font-family: 'Arial', sans-serif;
}

.main-container {
max-width: 1200px;
margin: 0 auto;
}

h1, h2, h3, h4, h5, h6 {
text-align: center;
margin: 20px 0;
}

.leaflet-container {
margin: 20px auto;
display: block;
}

table {
margin: 20px auto;
max-width: 800px;
}

.table {
margin: 20px auto;
}

p {
text-align: justify;
margin: 15px 0;
}

.tocify-wrapper {
position: fixed;
top: 0;
left: 0;
width: 260px;
height: 100%;
overflow: auto;
z-index: 1000;
}

.col-md-9 {
margin-left: 280px;
max-width: calc(100% - 300px);
}

/* Center specific elements */
.centered-content {
text-align: center;
margin: 20px auto;
}

/* Map container centering */
.map-container {
display: flex;
justify-content: center;
margin: 20px 0;
}

/* Ensure leaflet maps are responsive and centered */
.leaflet {
max-width: 100%;
height: 400px;
margin: 0 auto;
}

/* Style for configuration table */
.config-table {
margin: 20px auto;
max-width: 600px;
}

/* Center all chunk outputs */
.chunk-output {
text-align: center;
}

/* Center kable tables */
.kable-table {
margin-left: auto;
margin-right: auto;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 12, fig.height = 8)
# load all packages and custom functions without having to identify individual functions
source("global.R")

# Function to render individual maps using function directly
render_individual_map_from_config <- function(config) {
  # Get AOI data same way as the server
  aoi_data <- params$aoi_data
  
  # Call the pure function directly - this generates the exact same map as the app
  return(create_individual_map(config, aoi_data))
}
```

## Data Layers Information

This report includes data from the following selected layers, with their last update timestamps:

```{r}
if (is.null(params$data_timestamps)) {
  # Call the same function used in your app
  timestamp_info <- get_data_timestamps()
  data_timestamps_table <- timestamp_info$data_timestamps
} else {
  data_timestamps_table <- params$data_timestamps$data_timestamps
}

if (!is.null(data_timestamps_table)) {
  display_table <- data_timestamps_table %>%
    filter(!is.na(formatted_date)) %>%
    select(dataset_name, description, formatted_date) %>%
    rename(
      "Dataset" = dataset_name,
      "Description" = description,
      "Last Updated" = formatted_date
    )
  
  if (nrow(display_table) > 0) {
    kable(display_table, 
          caption = "Selected Data Layer Update Information",
          format = "html",
          table.attr = "class='table table-striped'")
  } else {
    cat("No timestamp information available for the selected data layers.")
  }
} else {
  cat("Timestamp information not available.")
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 1) {
  config <- params$map_configs[[1]]
  cat("### Map 1:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")

  # Generate the map
  render_individual_map_from_config(config)
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 2) {
  config <- params$map_configs[[2]]
  cat("### Map 2:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")
  
  # Generate the map
  render_individual_map_from_config(config)
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 3) {
  config <- params$map_configs[[3]]
  cat("### Map 3:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")

  # Generate the map
  render_individual_map_from_config(config)
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 4) {
  config <- params$map_configs[[4]]
  cat("### Map 4:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")
 
  # Generate the map
  render_individual_map_from_config(config)
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 5) {
  config <- params$map_configs[[5]]
  cat("### Map 5:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")

  # Generate the map
  render_individual_map_from_config(config)
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 6) {
  config <- params$map_configs[[6]]
  cat("### Map 6:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")

  # Generate the map
  render_individual_map_from_config(config)
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 7) {
  config <- params$map_configs[[7]]
  cat("### Map 7:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")

  # Generate the map
  render_individual_map_from_config(config)
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 8) {
  config <- params$map_configs[[8]]
  cat("### Map 8:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")

  # Generate the map
  render_individual_map_from_config(config)
}
```

<!-- ## Combined Maps -->

<!-- ### Combined Map - Geometric Mean -->
<!-- ```{r} -->
<!-- if (!is.null(params$selected_methods) && "geometric_mean" %in% params$selected_methods &&  -->
<!--     !is.null(params$combined_data_list) && "geometric_mean" %in% names(params$combined_data_list)) { -->
<!--   combined_data <- params$combined_data_list[["geometric_mean"]] -->
<!--   if(!is.null(combined_data)) { -->
<!--     # Count only cells with scores not equal to 0 or NA -->
<!--     valid_data_points <- nrow(combined_data[!is.na(combined_data$Geo_mean) & combined_data$Geo_mean != 0, ]) -->
<!--     cat("**Combined Data Points:** ", valid_data_points, "  \n") -->
<!--     cat("**Calculation Method:** Geometric Mean  \n\n") -->
<!--   } -->
<!-- } else { -->
<!--   cat("*Geometric mean calculation method was not selected or data is not available.*\n\n") -->
<!-- } -->

<!-- if (!is.null(params$selected_methods) && "geometric_mean" %in% params$selected_methods &&  -->
<!--     !is.null(params$combined_data_list) && "geometric_mean" %in% names(params$combined_data_list)) { -->
<!--   combined_data <- params$combined_data_list[["geometric_mean"]] -->
<!--   if(!is.null(combined_data)) { -->
<!--     create_combined_map(combined_data, paste(params$combined_map_title, "- Geometric Mean"), "geometric_mean", aoi_data = params$aoi_data) -->
<!--   } -->
<!-- } -->
<!-- ``` -->

<!-- ### Combined Map - Lowest Score -->

<!-- ```{r} -->
<!-- if (!is.null(params$selected_methods) && "lowest" %in% params$selected_methods &&  -->
<!--     !is.null(params$combined_data_list) && "lowest" %in% names(params$combined_data_list)) { -->
<!--   combined_data <- params$combined_data_list[["lowest"]] -->
<!--   if(!is.null(combined_data)) { -->
<!--     # Count only cells with scores not equal to 0 or NA -->
<!--     value_column <- if("Lowest" %in% names(combined_data)) "Lowest" else "Lowest_value" -->
<!--     valid_data_points <- nrow(combined_data[!is.na(combined_data[[value_column]]) & combined_data[[value_column]] != 0, ]) -->
<!--     cat("**Combined Data Points:** ", valid_data_points, "  \n") -->
<!--     cat("**Calculation Method:** Lowest Score  \n\n") -->
<!--   } -->
<!-- } else { -->
<!--   cat("*Lowest score calculation method was not selected or data is not available.*\n\n") -->
<!-- } -->
<!-- ``` -->

<!-- ```{r} -->
<!-- if (!is.null(params$selected_methods) && "lowest" %in% params$selected_methods &&  -->
<!--     !is.null(params$combined_data_list) && "lowest" %in% names(params$combined_data_list)) { -->
<!--   combined_data <- params$combined_data_list[["lowest"]] -->
<!--   if(!is.null(combined_data)) { -->
<!--     create_combined_map(combined_data, paste(params$combined_map_title, "- Lowest Score"), "lowest", aoi_data = params$aoi_data) -->
<!--   } -->
<!-- } -->
<!-- ``` -->

<!-- ### Combined Map - Product -->

<!-- ```{r} -->
<!-- if (!is.null(params$selected_methods) && "product" %in% params$selected_methods &&  -->
<!--     !is.null(params$combined_data_list) && "product" %in% names(params$combined_data_list)) { -->
<!--   combined_data <- params$combined_data_list[["product"]] -->
<!--   if(!is.null(combined_data)) { -->
<!--     # Count only cells with scores not equal to 0 or NA -->
<!--     value_column <- if("Product" %in% names(combined_data)) "Product" else "Product_value" -->
<!--     valid_data_points <- nrow(combined_data[!is.na(combined_data[[value_column]]) & combined_data[[value_column]] != 0, ]) -->
<!--     cat("**Combined Data Points:** ", valid_data_points, "  \n") -->
<!--     cat("**Calculation Method:** Product  \n\n") -->
<!--   } -->
<!-- } else { -->
<!--   cat("*Product calculation method was not selected or data is not available.*\n\n") -->
<!-- } -->
<!-- ``` -->

<!-- ```{r} -->
<!-- if (!is.null(params$selected_methods) && "product" %in% params$selected_methods &&  -->
<!--     !is.null(params$combined_data_list) && "product" %in% names(params$combined_data_list)) { -->
<!--   combined_data <- params$combined_data_list[["product"]] -->
<!--   if(!is.null(combined_data)) { -->
<!--     create_combined_map(combined_data, paste(params$combined_map_title, "- Product"), "product", aoi_data = params$aoi_data) -->
<!--   } -->
<!-- } -->
<!-- ``` -->
