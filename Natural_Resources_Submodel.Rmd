---
title: "Natural Resources Submodel Report"
date: "`r format(Sys.time(), '%B %d, %Y at %H:%M:%S')`"
output: 
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    self_contained: true
params:
  map_configs: NULL
  combined_data: NULL
  tab_name: "Natural Resources"
  combined_map_title: "Combined Map"
  data_timestamps: NULL
---
<style>
body {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  font-family: 'Arial', sans-serif;
}

.main-container {
  max-width: 1200px;
  margin: 0 auto;
}

h1, h2, h3, h4, h5, h6 {
  text-align: center;
  margin: 20px 0;
}

.leaflet-container {
  margin: 20px auto;
  display: block;
}

table {
  margin: 20px auto;
  max-width: 800px;
}

.table {
  margin: 20px auto;
}

p {
  text-align: justify;
  margin: 15px 0;
}

.tocify-wrapper {
  position: fixed;
  top: 0;
  left: 0;
  width: 260px;
  height: 100%;
  overflow: auto;
  z-index: 1000;
}

.col-md-9 {
  margin-left: 280px;
  max-width: calc(100% - 300px);
}

/* Center specific elements */
.centered-content {
  text-align: center;
  margin: 20px auto;
}

/* Map container centering */
.map-container {
  display: flex;
  justify-content: center;
  margin: 20px 0;
}

/* Ensure leaflet maps are responsive and centered */
.leaflet {
  max-width: 100%;
  height: 400px;
  margin: 0 auto;
}

/* Style for configuration table */
.config-table {
  margin: 20px auto;
  max-width: 600px;
}

/* Center all chunk outputs */
.chunk-output {
  text-align: center;
}

/* Center kable tables */
.kable-table {
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 12, fig.height = 8)

# Load required libraries
suppressPackageStartupMessages({
  library(leaflet)
  library(sf)
  library(dplyr)
  library(knitr)
  library(htmltools)
})

# Null coalescing operator
`%||%` <- function(x, y) if(is.null(x)) y else x

# Color palette for scores
score_colors <- list(
  "0.1" = "#E41A1C",  # red
  "0.2" = "#377EB8",  # blue
  "0.3" = "#4DAF4A",  # green
  "0.4" = "#984EA3",  # purple
  "0.5" = "#FF7F00",  # orange
  "0.6" = "#FFFF33",  # yellow
  "0.7" = "#A65628",  # brown
  "0.8" = "#F781BF",  # pink
  "0.9" = "#999999",  # grey
  "1" = "#000000"     # black
)

# Function to create individual maps
create_individual_map <- function(data, layer_name, score_value, map_title) {
  # Ensure data is in the correct CRS for leaflet
  if (inherits(data, 'sf') && !identical(st_crs(data)$input, '+proj=longlat +datum=WGS84')) {
    data <- st_transform(data, '+proj=longlat +datum=WGS84')
  }
  
  # Get color for the score
  color <- score_colors[[as.character(score_value)]] %||% '#000000'
  
  # Create the map
  leaflet(data) %>%
    addProviderTiles("Esri.OceanBasemap",
                     options = providerTileOptions(variant = "Ocean/World_Ocean_Base")) %>%
    addProviderTiles("Esri.OceanBasemap",
                     options = providerTileOptions(variant = "Ocean/World_Ocean_Reference")) %>%
    addPolygons(
      fillColor = color,
      weight = 1,
      opacity = 1,
      color = '#00000000',
      fillOpacity = 0.7,
      popup = ~paste0(
        '<strong>Layer:</strong> ', layer_name, '<br>',
        '<strong>Score:</strong> ', score_value, '<br>',
        '<strong>Cell ID:</strong> ', CellID_2km
      )
    ) %>%
    addLegend(
      position = 'bottomright',
      colors = color,
      labels = paste('Score:', score_value),
      title = layer_name,
      opacity = 0.7
    )
}

# Function to create combined map
create_combined_map <- function(combined_data, title) {
  if (is.null(combined_data) || !'Geo_mean' %in% names(combined_data)) {
    return(leaflet() %>%
             addProviderTiles("Esri.OceanBasemap") %>%
             addControl("No combined data available for this report.", position = "topright"))
  }
  
  # Ensure data is in the correct CRS for leaflet
  if (inherits(combined_data, 'sf') && !identical(st_crs(combined_data)$input, '+proj=longlat +datum=WGS84')) {
    combined_data <- st_transform(combined_data, '+proj=longlat +datum=WGS84')
  }
  
  # Filter out NA values for domain calculation
  valid_values <- combined_data$Geo_mean[!is.na(combined_data$Geo_mean)]
  
  if(length(valid_values) == 0) {
    return(leaflet() %>%
             addProviderTiles("Esri.OceanBasemap") %>%
             addControl("No valid geometric mean data available.", position = "topright"))
  }
  
  # Create color palette for geometric mean values
  pal <- colorNumeric(
    palette = "viridis",
    domain = range(valid_values),
    na.color = 'transparent'
  )
  
  leaflet(combined_data) %>%
    addProviderTiles("Esri.OceanBasemap",
                     options = providerTileOptions(variant = "Ocean/World_Ocean_Base")) %>%
    addProviderTiles("Esri.OceanBasemap",
                     options = providerTileOptions(variant = "Ocean/World_Ocean_Reference")) %>%
    addPolygons(
      fillColor = ~pal(Geo_mean),
      weight = 1,
      opacity = 1,
      color = '#00000000',
      fillOpacity = 0.7,
      popup = ~paste0(
        '<strong>Geometric Mean:</strong> ', round(Geo_mean, 3), '<br>',
        '<strong>Cell ID:</strong> ', CellID_2km
      )
    ) %>%
    addLegend(
      pal = pal,
      values = ~Geo_mean,
      title = title,
      position = 'bottomright',
      opacity = 1
    )
}

# Source the data timestamps function if not provided as parameter
if (is.null(params$data_timestamps)) {
  source("data_timestamps.R")
  timestamp_info <- get_data_timestamps()
} else {
  timestamp_info <- params$data_timestamps
}
```

```{r}
if (!is.null(params$map_configs) && length(params$map_configs) > 0) {
  config_df <- data.frame(
    'Map' = 1:length(params$map_configs),
    'Layer Name' = sapply(params$map_configs, function(x) x$layer),
    'Score Value' = sapply(params$map_configs, function(x) x$score),
    'Data Points' = sapply(params$map_configs, function(x) nrow(x$data)),
    stringsAsFactors = FALSE
  )
  
 # Create centered table
  cat('<div class="config-table">')
  print(kable(config_df, caption = paste(params$tab_name, 'Layer Configuration Details'), format = "html", table.attr = "class='table table-striped'"))
  cat('</div>')
} else {
  cat('<div class="centered-content">No individual layers were configured for this report.</div>')
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 1) {
  config <- params$map_configs[[1]]
   cat('<div class="centered-content">')
  cat("### Map 1:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")
  cat('</div>')
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 1) {
  config <- params$map_configs[[1]]
  create_individual_map(
    data = config$data,
    layer_name = config$layer,
    score_value = config$score,
    map_title = "Map 1"
  )
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 2) {
  config <- params$map_configs[[2]]
  cat("### Map 2:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 2) {
  config <- params$map_configs[[2]]
  create_individual_map(
    data = config$data,
    layer_name = config$layer,
    score_value = config$score,
    map_title = "Map 2"
  )
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 3) {
  config <- params$map_configs[[3]]
  cat("### Map 3:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 3) {
  config <- params$map_configs[[3]]
  create_individual_map(
    data = config$data,
    layer_name = config$layer,
    score_value = config$score,
    map_title = "Map 3"
  )
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 4) {
  config <- params$map_configs[[4]]
  cat("### Map 4:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 4) {
  config <- params$map_configs[[4]]
  create_individual_map(
    data = config$data,
    layer_name = config$layer,
    score_value = config$score,
    map_title = "Map 4"
  )
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 5) {
  config <- params$map_configs[[5]]
  cat("### Map 5:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 5) {
  config <- params$map_configs[[5]]
  create_individual_map(
    data = config$data,
    layer_name = config$layer,
    score_value = config$score,
    map_title = "Map 5"
  )
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 6) {
  config <- params$map_configs[[6]]
  cat("### Map 6:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 6) {
  config <- params$map_configs[[6]]
  create_individual_map(
    data = config$data,
    layer_name = config$layer,
    score_value = config$score,
    map_title = "Map 6"
  )
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 7) {
  config <- params$map_configs[[7]]
  cat("### Map 7:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 7) {
  config <- params$map_configs[[7]]
  create_individual_map(
    data = config$data,
    layer_name = config$layer,
    score_value = config$score,
    map_title = "Map 7"
  )
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 8) {
  config <- params$map_configs[[8]]
  cat("### Map 8:", config$layer, "(Score:", config$score, ")\n\n")
  cat("**Layer:** ", config$layer, "  \n")
  cat("**Score:** ", config$score, "  \n") 
  cat("**Data Points:** ", nrow(config$data), "  \n\n")
}
```

```{r}
if(!is.null(params$map_configs) && length(params$map_configs) >= 8) {
  config <- params$map_configs[[8]]
  create_individual_map(
    data = config$data,
    layer_name = config$layer,
    score_value = config$score,
    map_title = "Map 8"
  )
}
```

```{r}
if (!is.null(params$combined_data)) {
  cat("**Combined Data Points:** ", nrow(params$combined_data), "  \n")
  cat("**Calculation Method:** Geometric Mean  \n\n")
} else {
  cat("No combined map data available. Please generate a combined map in the application first.\n\n")
}
```

```{r}
if (!is.null(params$combined_data)) {
  # Create and display the combined map
  combined_map <- create_combined_map(params$combined_data, params$combined_map_title)
  combined_map
} else {
  leaflet() %>%
    addProviderTiles("Esri.OceanBasemap") %>%
    addControl("No combined map data available.", position = "topright")
}
```

## Data Layers Information

This report includes data from the following selected layers, with their last update timestamps:

```{r}
if (!is.null(params$data_timestamps) && !is.null(params$data_timestamps$data_timestamps)) {
  display_table <- params$data_timestamps$data_timestamps %>%
    filter(!is.na(formatted_date)) %>%
    select(dataset_name, formatted_date) %>%
    rename(
      "Dataset" = dataset_name,
      "Last Updated" = formatted_date
    )
  
  if (nrow(display_table) > 0) {
    kable(display_table, 
          caption = "Selected Data Layer Update Information",
          format = "html",
          table.attr = "class='table table-striped'")
  } else {
    cat("No timestamp information available for the selected data layers.")
  }
} else {
  cat("Timestamp information not available.")
}